#!/usr/bin/env ruby

require 'rubygems'
gem 'activerecord', '= 2.2.2'

require 'taps/schema'

cmd = ARGV.shift.strip rescue ''
database_url = ARGV.shift.strip rescue ''

def show_usage_and_exit
	puts <<EOTXT
	schema console <database_url>
	schema dump <database_url>
	schema indexes <database_url>
	schema reset_db_sequences <database_url>
	schema load <database_url> <schema_file>
	schema load_indexes <database_url> <indexes_file>
EOTXT
	exit(1)
end

case cmd
when 'dump'
	puts Taps::Schema.dump_without_indexes(database_url)
when 'indexes'
	puts Taps::Schema.indexes(database_url)
when 'load_indexes'
	filename = ARGV.shift.strip rescue ''
	indexes = File.read(filename) rescue show_usage_and_exit
	Taps::Schema.load_indexes(database_url, indexes)
when 'load'
	filename = ARGV.shift.strip rescue ''
	schema = File.read(filename) rescue show_usage_and_exit
	Taps::Schema.load(database_url, schema)
when 'reset_db_sequences'
	Taps::Schema.reset_db_sequences(database_url)
when 'console'
	Taps::Schema.connection(database_url)
	$db = ActiveRecord::Base.connection
	require 'irb'
	require 'irb/completion'
	IRB.start
else
	show_usage_and_exit
end
